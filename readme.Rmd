---
title: "SIRM.FTMS.peakPickingMethods"
git_commit: "`r substr(git2r::branch_target(git2r::head(git2r::repository())), 1, 8)`"
date: "`r Sys.time()`"
output: 
  md_document:
    preserve_yaml: TRUE
---

# SIRM.FTMS.peakPickingMethods

## About

This package is for implementing and testing various peak picking methods,
as well as providing classes and methods for working with the raw mass-spec
data and the picked peaks.

## Installation

```r
git clone https://gitlab.cesb.uky.edu/rmflight/SIRM.FTMS.peakPickingMethods.git
cd SIRM.FTMS.peakPickingMethods.git
R
devtools::install()
```

## PreRequisites

```r
library(BiocInstaller)
biocLite("xcms")
install.packages("pracma")
```

## Generating mzML

If all you have is Thermo `raw` files, you can convert those using `msconvert`
on the windows command line:

```
msconvert *.RAW -o output_dir
```

You should probably not be selecting the scans to output at this point, because
you may want them later. Better to select scans when you've read in the data from
the `mzML`. If you limit the scans when converting, you will have to re-run the
conversion if you decide you want other ones later.

## Analyzing Data

To analyze the data, you will make use of the `AnalyzeMS` class to control the
overall analysis workflow.

### Finding Peaks

One of the major plusses of using this package, is the ability to change the
**peak finding** method used. However, this does create some overhead for you
if you want to use a custom peak finding function. This is due to wrapping the 
**peak finding** function in another function that documents the function that
was used. Below is an example (this is actually the current default in the package):

```{r}
find_peaks_default <- function(data, scan_range){
  avg_data <- as.data.frame(xcms::getSpec(data, scanrange = scan_range))
  avg_data$ObservedMZ <- avg_data$mz
  avg_data$Intensity <- avg_data$intensity
  avg_data$mz <- NULL
  avg_data$intensity <- NULL
  avg_peaks <- find_peaks_diff(avg_data)
  
  function_call <- "find_peaks_diff"
  function_pkg <- find(function_call)
  pkg_desc <- utils::packageDescription(substring(function_pkg, 9))
  if (!is.null(pkg_desc$RemoteSha)) {
    pkg_sha <- pkg_desc$RemoteSha
  } else {
    pkg_sha <- ""
  }
  pkg_version <- packageVersion(substring(function_pkg, 9))
  picking_description <- list(package = function_pkg,
                             version = pkg_desc$Version,
                             sha = pkg_sha,
                             function_called = function_call,
                             parameters = list(scan_range = force(scan_range))
                             )
  PeakPickingAnalysis$new(in_peaks = avg_peaks,
                          in_parameters = list(scan_range = force(scan_range),
                                                        picking_description = picking_description))
}
```

In this example, the actual **peak finding** function is `find_peaks_diff`, which
takes the averaged spectrum across scans generated by `xcms::getSpec`. After the
data generation, the rest of the code is all about **documenting** the function
that did the peak finding itself. This code should be part of every **peak finding**
function, otherwise we won't be able to track provenance.


### Analysis Workflow

Here is an example workflow starting from an mzML file that is included in
this package.

```{r analyze_it}
# get the file location
mzml_file <- system.file("extdata/mztest_big.mzML", package = "SIRM.FTMS.peakPickingMethods")

# initialize the AnalyzeMS object
analyze <- AnalyzeMS$new(mzml_file)

# load the data
analyze$load_file()
```





```{r runit, eval = FALSE, echo = FALSE}
rmarkdown::render("readme.Rmd")
```
