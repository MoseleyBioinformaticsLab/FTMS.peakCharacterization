---
title: "Checking different versions of code"
author: "Robert M Flight"
date: "`r Sys.time()`"
output: html_document
---

```{r setup}
library(SIRM.FTMS.peakCharacterization)
```


## Checking the Results Between Versions

Now we need to check the results. We do two checks:

1. That the new peaks are identical to a previous set of peaks (if available)
2. That we can do peak correspondence across two samples

### Comparing to Previous

#### Which Files

```{r define_sets}
prev_files <- dir("mspl_files_defaults_fullrun_X2017.07.11.16.19.33_0.0.183", full.names = TRUE, recursive = TRUE)
curr_files <- dir("mspl_files_defaults_fullrun_X2017.07.11.14.48.44_0.0.270", full.names = TRUE, recursive = TRUE)

curr_file_id <- basename(dirname(curr_files))
curr_files <- split(curr_files, curr_file_id)

prev_file_id <- basename(dirname(prev_files))
prev_files <- split(prev_files, prev_file_id)

prev_files <- lapply(prev_files, function(x){
  names(x) <- basename(x)
  x
})

curr_files <- lapply(curr_files, function(x){
  names(x) <- basename(x)
  x
})
```

#### Check 1, apspear lipid32

```{r load_data}
use_files <- "aspear_2061205_pos_lipid32_intermediate_files"
mspl_init <- lapply(c(prev_files[[use_files]]["multi_scan_peaklist_init.rds"], curr_files[[use_files]]["multi_scan_peaklist_init.rds"]), function(in_file){
  tmp_env <- new.env()
  load(in_file, envir = tmp_env)
  tmp_env
})
```

#### Check Some Random Peak Lists

```{r check_random_peaklists}
check_lists <- sample(52, 10)

mspl_get_scan <- function(peak_finder){
  all_scans <- peak_finder$multi_scan_peaklist$peak_list_by_scans
  vapply(all_scans, function(x){x$scan}, numeric(1))
}

check_scan_match <- lapply(mspl_init, function(x){
  mspl_get_scan(x$peak_finder)
})
all.equal(check_scan_match[[1]], check_scan_match[[2]])

mspl_get_peaks <- function(peak_finder, list_scans){
  all_scans <- peak_finder$multi_scan_peaklist$peak_list_by_scans[list_scans]
  lapply(all_scans, function(x){x$peak_list})
}

mspl_32_peaks <- lapply(mspl_init, function(x){
  mspl_get_peaks(x$peak_finder, check_lists)
})

all.equal(mspl_32_peaks[[1]], mspl_32_peaks[[2]])
```

OK, so at least the peak lists being generated from each scan are identical, and we have overall the same set of scans to start.

#### Check digital resolution filter & Correspondence

```{r dr_filter_corr_data}
corresp_data <- lapply(c(prev_files[[use_files]]["correspondent_peaklist.rds"], curr_files[[use_files]]["correspondent_peaklist.rds"]), function(in_file){
  tmp_env <- new.env()
  load(in_file, envir = tmp_env)
  tmp_env
})
```

```{r corresp_scans}
corresp_scans <- lapply(corresp_data, function(x){
  x$peak_finder$correspondent_peaks$master_peak_list$scan
})
all.equal(corresp_scans[[1]], corresp_scans[[2]])

corresp_obj <- lapply(corresp_data, function(x){
  x$peak_finder$correspondent_peaks$master_peak_list
})
all.equal(corresp_obj[[1]]$scan_area, corresp_obj[[2]]$scan_area)
all.equal(corresp_obj[[1]]$master, corresp_obj[[2]]$master)
```

So, initial correspondence is the same. That's good.

#### Check Collapsing & Information Content

```{r corresp_info}
collapse_data <- lapply(c(prev_files[[use_files]]["scan_information_content.rds"], curr_files[[use_files]]["scan_information_content.rds"]), function(in_file){
  tmp_env <- new.env()
  load(in_file, envir = tmp_env)
  tmp_env
})

all.equal(collapse_data[[1]]$peak_finder$correspondent_peaks$master_peak_list$master, collapse_data[[2]]$peak_finder$correspondent_peaks$master_peak_list$master)

all.equal(collapse_data[[1]]$peak_finder$correspondent_peaks$master_peak_list$scan_information_content, collapse_data[[2]]$peak_finder$correspondent_peaks$master_peak_list$scan_information_content)
```

#### Second Round

```{r second_corresp_scans}
corresp_data2 <- lapply(c(prev_files[[use_files]]["correspondent_peaklist2.rds"], curr_files[[use_files]]["correspondent_peaklist2.rds"]), function(in_file){
  tmp_env <- new.env()
  load(in_file, envir = tmp_env)
  tmp_env
})
```

```{r corresp_scans2}
corresp_scans2 <- lapply(corresp_data2, function(x){
  x$peak_finder$correspondent_peaks$master_peak_list$scan
})
all.equal(corresp_scans2[[1]], corresp_scans2[[2]])

corresp_obj2 <- lapply(corresp_data2, function(x){
  x$peak_finder$correspondent_peaks$master_peak_list
})
all.equal(corresp_obj2[[1]]$scan_area, corresp_obj2[[2]]$scan_area)
all.equal(corresp_obj2[[1]]$master, corresp_obj2[[2]]$master)
```

#### Final Set

```{r final_set}
final_data <- lapply(c(prev_files$mspl_files_defaults_fullrun_X2017.07.07.14.18.45_0.0.183[1], curr_files$mspl_files_defaults_fullrun_X2017.07.10.13.08.55_0.0.268[1]), function(in_file){
  tmp_env <- new.env()
  load(in_file, envir = tmp_env)
  tmp_env
})
```

```{r}
all.equal(final_data[[1]]$peak_finder$multi_scan_peaklist$scan_numbers(),
          final_data[[2]]$peak_finder$multi_scan_peaklist$scan_numbers())

all.equal(final_data[[1]]$peak_finder$correspondent_peaks$master_peak_list$normalization_factors,
          final_data[[2]]$peak_finder$correspondent_peaks$master_peak_list$normalization_factors)

all.equal(final_data[[1]]$peak_finder$correspondent_peaks$master_peak_list$master,
          final_data[[2]]$peak_finder$correspondent_peaks$master_peak_list$master)
```

