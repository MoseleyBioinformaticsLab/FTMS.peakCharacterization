```{r load_packages}
library(xml2)

mzml_file <- "/home/rmflight/Music/big_data_notbackup/CESB_rawdata/replication_study/cancer_positive_mode/mzml_full_conversion/SBC110871exopos.mzML"
```

```{r xml_file}
xml_doc <- read_xml(mzml_file)
ns <- xml_ns(xml_doc)
```

```{r sample_id}
mz_data <- xml_find_first(xml_doc, "/d1:indexedmzML/d1:mzML", ns)

sample_id <- xml_attr(mz_data, "id", ns)
```

```{r cv_list}
cv_nodes <- xml_children(xml_find_first(xml_doc, "/d1:indexedmzML/d1:mzML/d1:cvList", ns))
```

```{r file_description}
file_description <- xml_children(xml_find_first(xml_doc, "/d1:indexedmzML/d1:mzML/d1:fileDescription", ns))
```

```{r referenceableParam}
ref_param <- xml_children(xml_find_first(xml_doc, "/d1:indexedmzML/d1:mzML/d1:referenceableParamGroupList", ns))
```

```{r software_list}
software_list <- xml_children(xml_find_first(xml_doc, "/d1:indexedmzML/d1:mzML/d1:softwareList", ns))
```

```{r instrument_configuration_list}
instrument_configuration_list <- xml_children(
  xml_find_first(xml_doc, "/d1:indexedmzML/d1:mzML/d1:instrumentConfigurationList", ns))
```

```{r data_processing}
data_processing <- xml_children(
  xml_find_first(xml_doc, "/d1:indexedmzML/d1:mzML/d1:dataProcessingList", ns)
)
```

```{r run_info}
run_data <- xml_find_first(xml_doc, "/d1:indexedmzML/d1:mzML/d1:run", ns)
run_data2 <- list(name = xml_name(run_data),
                  attrs = xml_attrs(run_data))
```

```{r setup_paths}
children_path_list <- list(cv = c("indexedmzML", "mzML", "cvList"),
                           file_description = c("indexedmzML", "mzML", "fileDescription"),
                           ref_param = c("indexedmzML", "mzML", "referenceableParamGroupList"),
                           software_list = c("indexedmzML", "mzML", "softwareList"),
                           instrument_configuration_list = c("indexedmzML", "mzML",
                                                             "instrumentConfigurationList"),
                           data_processing = c("indexedmzML", "mzML", "dataProcessingList"))

node_only_path_list <- list(mz_data = c("indexedmzML", "mzML"),
                            run_data = c("indexedmzML", "mzML", "run"))

spectrum_cvparam_path <- c("indexedmzML", "mzML", "run", "spectrumList", "spectrum", "cvParam")
```

```{r make_path}
namespace_obj <- ns
namespace_str <- "psi"
path_def <- children_path_list[["cv"]]
make_xml_path <- function(path_def, namespace_obj, namespace_str = "psi"){
  which_namespace <- which.min(which(grepl(namespace_str, namespace_obj)))
  ns_pre <- names(namespace_obj)[which_namespace]
  
  path_with_pre <- paste0("/", ns_pre, ":", path_def)
  path_collapsed <- paste(path_with_pre, collapse = "")
  
  path_collapsed
}
```

```{r child_paths}
child_paths <- lapply(children_path_list, make_xml_path, ns)
child_nodes <- lapply(child_paths, function(in_path){
  xml_children(xml_find_first(xml_doc, in_path, ns))
})
```

```{r get_all_children_recursively}
get_nested_children <- function(xml_obj){
  print(xml_name(xml_obj))
  obj_children <- xml_children(xml_obj)
  out_obj <- vector("list", 3)
  out_obj[[1]] <- xml_name(xml_obj)
  out_obj[[2]] <- xml_attrs(xml_obj)
  if (length(obj_children) > 0){
    out_obj[[3]] <- lapply(obj_children, get_nested_children)
  } 
  out_obj
}


all_children <- lapply(child_nodes, function(x){
  lapply(x, get_nested_children)
})
```

