---
title: "initial peakcomparisons"
author: "Robert M Flight <rflight79@gmail.com>"
date: "`r Sys.time()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{initial peakcomparisons}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup}
library(ftmsComparePeaks)
library(dplyr)
library(ggplot2)
library(cowplot)
```

# Single Files

```{r single_files}
mz_file <- "/home/rmflight/Projects/work/CESB/ftms.QC/mzML_exported/92Cpos.mzML"
xcal_file <- "/home/rmflight/Projects/work/CESB/ftms.QC/exported_noref/92Cpos.xlsx"
```

## Peaks

```{r get_peaks}
mz_avg <- import_mzML(mz_file)
mz_peaks <- find_peaks(mz_avg, m = 3)

xcal_peaks <- import_xcalibur(xcal_file)
```

## XCAL - MZ

```{r xcal_mz}
xcal_mz <- find_closest_peaks(mz_peaks, xcal_peaks, "mz", "xcal")

filter(xcal_mz, mz_diff != 0, mz_diff <= 1e-3) %>% nrow()
nrow(xcal_peaks)
```

## MZ - XCAL

```{r mz_xcal}
mz_xcal <- find_closest_peaks(xcal_peaks, mz_peaks, "xcal", "mz")
filter(mz_xcal, mz_diff != 0, mz_diff <= 1e-3) %>% nrow()
```


## Find Peaks that are not Closest Peaks

We refine the closest peaks by finding those ones that don't have a closest match
between the two comparisons.

```{r refine_peaks}
xcal_mz_not_min <- refine_closest_list(xcal_mz)
mz_xcal_not_min <- refine_closest_list(mz_xcal)
```

## Match in Both

```{r match_both}
xcal_mz_keep <- filter(xcal_mz, !(s_peak %in% xcal_mz_not_min$not_min_s))
mz_xcal_keep <- filter(mz_xcal, !(s_peak %in% mz_xcal_not_min$not_min_s))

in_both <- unique(intersect(xcal_mz_keep$q_peak, mz_xcal_keep$s_peak))
length(in_both)

length(unique(xcal_mz_keep$s_peak))
length(unique(mz_xcal_keep$s_peak))
```

## How Many Have Big Differences?

```{r big_diffs}
length(unique(xcal_mz_keep$s_peak))
sum(filter(xcal_mz_keep, mz_diff != 0) %>% select(., mz_diff) %>% unlist() <= 1e-3)
```

## View Them

```{r check_peaks}
head(mz_xcal_not_min$not_min_s)
filter(mz_xcal, q_peak %in% 220)
xcal_plot <- plot_peaks(filter(mz_xcal, q_peak %in% 220), mz_avg, 1e-4)
xcal_plot
```


OK, so lets see if we can get rid of some of these little shoulders.

```{r delete_shoulders}
small_avg <- filter(mz_avg, (mz >= 151.66) & (mz <= 151.672))
small_xcal <- filter(xcal_peaks, (mz >= 151.66) & (mz <= 151.672))

small_mz <- find_peaks(small_avg, m = 5)

p <- ggplot(small_avg, aes(x = mz, y = intensity)) + geom_line()
p <- p + geom_point(data = small_xcal, color = "red")
p <- p + geom_point(data = small_mz, color = "blue")
p
```

Awesome! Now lets try doing this on everything else.

```{r mz_2}
mz_peaks2 <- find_peaks(mz_avg, m = 5)

xcal_mz2 <- find_closest_peaks(mz_peaks2, xcal_peaks, "mz", "xcal")

filter(xcal_mz2, mz_diff != 0, mz_diff <= 1e-3) %>% nrow()
nrow(xcal_peaks)

mz_xcal2 <- find_closest_peaks(xcal_peaks, mz_peaks2, "xcal", "mz")
filter(mz_xcal2, mz_diff != 0, mz_diff <= 1e-3) %>% nrow()

xcal_mz_not_min2 <- refine_closest_list(xcal_mz2)
mz_xcal_not_min2 <- refine_closest_list(mz_xcal2)
```

Now, how many of our `mz` peaks have only a single match?

```{r mz_single}
mz_xcal2_singles <- filter(mz_xcal2, !(s_peak %in% mz_xcal_not_min2$not_min_s))

mz_xcal2_singles_diff <- filter(mz_xcal2_singles, which == "xcal", mz_diff <= 5e-4)
nrow(mz_xcal2_singles_diff)
```

```{r plot_mismatch}
q <- plot_peaks(filter(mz_xcal2, q_peak %in% 1171), mz_avg, 5e-5)
q
```

What is underneath here? Lets look at the underlying scan data.

```{r get_scan_data}
rawdata <- xcms::xcmsRaw(mz_file, profstep = 0)

n_scan <- length(rawdata@scanindex)

scan_limit <- c(173.44207, 173.44221)
scan_values <- lapply(seq(1, n_scan), function(in_scan){
  tmp_scan <- as.data.frame(xcms::getScan(rawdata, in_scan, scan_limit))
  
  if (nrow(tmp_scan) > 0) {
    tmp_scan$scan <- in_scan
  }
  tmp_scan
})

scan_values <- do.call(rbind, scan_values)

scan_values$scan <- factor(scan_values$scan)

q + geom_line(data = scan_values, aes(color = scan))
```

## More Information

What we are really interested in is:

* Do we match (5e-4) the majority of XCalibur peaks?
* What fraction of peaks do we match?
* If we miss peaks, do the missed peaks make sense?
* If we find extra peaks, do they make sense (see above plot for an example)?

### Matching

```{r deeper_examination}
xcal_peaks <- xcal_peaks[order(xcal_peaks$intensity, decreasing = TRUE), ]
mz_peaks2 <- mz_peaks2[order(mz_peaks2$intensity, decreasing = TRUE), ]

xcal_mz_deeper <- find_closest_peaks(mz_peaks2, xcal_peaks, "mz", "xcal")

xcal_found_peaks <- filter(xcal_mz_deeper, which == "mz", mz_diff <= 5e-5) %>% 
  select(s_peak) %>% unlist(., use.names = FALSE)

xcal_missed_peaks <- xcal_peaks[-xcal_found_peaks,]

# how many peaks are we finding
(length(xcal_found_peaks) / nrow(xcal_peaks)) * 100

# how much of the peak intensity are we matching?
(sum(xcal_missed_peaks$intensity) / sum(xcal_peaks$intensity)) * 100
```

### Missed

```{r missed_peaks}
# do the missed peaks make sense that we missed them? i.e. are they really missed?
xcal_mz_deeper_missed <- filter(xcal_mz_deeper, !(s_peak %in% xcal_found_peaks))

miss_1 <- plot_peaks(filter(xcal_mz_deeper_missed, s_peak %in% 143), mz_avg, 5e-3)
miss_2 <- plot_peaks(filter(xcal_mz_deeper_missed, s_peak %in% 216), mz_avg, 1e-2)
miss_3 <- plot_peaks(filter(xcal_mz_deeper_missed, s_peak %in% 411), mz_avg, 1e-2)

miss_1
miss_2
miss_3
```

Interesting, in all of these cases it appears that Thermo is actually taking
the center of the peak. 

```{r diff_plot}
rng_3 <- range(miss_3$data$mz)
test_mz <- filter(mz_avg, (mz >= rng_3[1]) & (mz <= rng_3[2]))

diff_plot <- ggplot(test_mz, aes(x = mz, y = intensity)) + geom_line() + 
  geom_point(data = filter(xcal_peaks, (mz >= min(test_mz$mz)) & (mz <= max(test_mz$mz))), color = "red") +
  geom_point(data = filter(mz_peaks2, (mz >= min(test_mz$mz)) & (mz <= max(test_mz$mz))), color = "blue")
diff_plot
```


Next thing to try, find peaks in each scan, and then average the location and 
intensity of the peaks that are very close to each other. Try this on the test
data first before extending to full data set.

### Find Peaks Then Average

```{r get_scan_data2}
rawdata <- xcms::xcmsRaw(mz_file, profstep = 0)
mz_range <- range(test_mz$mz)
scan_data <- lapply(seq(1, length(rawdata@scanindex)), function(in_scan){
  tmp_scan <- tbl_df(as.data.frame(xcms::getScan(rawdata, in_scan, mz_range)))
  
  if (nrow(tmp_scan) > 0){
    tmp_peaks <- find_peaks(tmp_scan)
    tmp_peaks$scan <- in_scan
  } else {
    tmp_peaks <- tmp_scan
  }
  tmp_peaks
})

all_peaks <- do.call(rbind, scan_data)
```

```{r plot_all_peaks}
p_all_peaks <- ggplot(all_peaks, aes(x = mz, y = intensity)) + geom_point()
p_all_peaks
```


Based on this image, we can set the peaks from the scans into 4 separate groups.

```{r cluster_mz}
indiv_loc <- list(loc_1 = filter(one_peak, mz < 1486.119),
                  loc_2 = filter(one_peak, (mz >= 1486.119) & (mz < 1486.121)),
                  loc_3 = filter(one_peak, (mz >= 1486.121) & (mz < 1486.123)),
                  loc_4 = filter(one_peak, (mz >= 1486.123)))

indiv_loc$loc_2_3 <- rbind(indiv_loc$loc_2, indiv_loc$loc_3)

loc_sd <- vapply(indiv_loc, function(x){sd(x$mz)}, numeric(1))
loc_mn <- vapply(indiv_loc, function(x){mean(x$mz)}, numeric(1))
summary_table <- cbind(loc_mn, loc_sd)
knitr::kable(summary_table, format.args = list(digits = 9))

loc_diff <- diff(loc_mn)
print(loc_diff, digits = 5)
```

Finally, is there any overlap in which scans gave which peak?

```{r overlap_scans}
intersect(indiv_loc$loc_2$scan, indiv_loc$loc_3$scan)
```

Nope, nothing in overlap. Lets actually look at the raw scan data.

```{r raw_scan_data}
rawdata <- xcms::xcmsRaw(mz_file, profstep = 0)
one_range <- c(1486.116, 1486.13)
scan_data <- lapply(seq(1, length(rawdata@scanindex)), function(in_scan){
  tmp_scan <- tbl_df(as.data.frame(xcms::getScan(rawdata, in_scan, one_range)))
  
  if (nrow(tmp_scan) > 0){
    tmp_scan$scan <- in_scan
  } 
  tmp_scan
})

all_scans <- do.call(rbind, scan_data)
```

```{r plot_scans}
scan_1 <- ggplot(filter(all_scans, scan <= 10), aes(x = mz, y = intensity, color = as.factor(scan))) + geom_line() + geom_point()

scan_2 <- ggplot(filter(all_scans, (scan > 10) & (scan <= 20)), aes(x = mz, y = intensity, color = as.factor(scan))) + geom_line() + geom_point()

scan_3 <- ggplot(filter(all_scans, (scan > 20) & (scan <= 30)), aes(x = mz, y = intensity, color = as.factor(scan))) + geom_line() + geom_point()

scan_4 <- ggplot(filter(all_scans, (scan > 30) & (scan <= 40)), aes(x = mz, y = intensity, color = as.factor(scan))) + geom_line() + geom_point()

scan_1
scan_2
scan_3
scan_4
```


```{r save_plot_data}
save(miss_1, miss_2, miss_3, diff_plot, p_all_peaks, scan_1, scan_2, scan_3, scan_4, file = "harmonics_in_scans.RData")
```

