---
title: "Transient Level Peak Picking"
author: "Robert M Flight"
date: "`r Sys.time()`"
commit: "`r substr(git2r::branch_target(git2r::head(git2r::repository())), 1, 8)`"
output: 
  pdf_document: 
    toc: yes
---

# Purpose

Working out how to do transient level peak picking.

# Data

Lets load up some data working at the transient level.

```{r load_transient_level}
library(xcms)
library(dplyr)
library(ggplot2)
library(SIRM.FTMS.peakPickingMethods)
library(ggplot2)
options(digits = 16)

mz_file <- "/home/rmflight/Projects/work/CESB/ftms.QC/mzML_exported/92Cpos.mzML"
rawdata <- xcms::xcmsRaw(mz_file, profstep = 0)
scan_level <- as.data.frame(xcms::getScan(rawdata, 1))

scan_test <- filter(scan_level, (mz >= 150.026) & (mz <= 150.0271))
mz_data <- scan_test
```

```{r try_cauchy_function}
cauchy_estimate <- function(x, max_real, params){
  xnot <- params[1]
  g <- params[2]
  max_real <- max_real[1]
  denom <- pi * g * (1 + ((x - xnot) / g)^2)
  new_y <- 1 / denom
  scale_factor <- max_real / max(new_y)
  new_y * scale_factor
}

test_mz <- mz_data
x.0 <- median(test_mz[test_mz$intensity >= 400, "mz"])
gamma.0 <- 1e-4

out_cauchy <- cauchy_estimate(test_mz$mz, max(test_mz$intensity), c(x.0, gamma.0, max(test_mz$intensity)))

test_plot <- test_mz[, c("mz", "intensity")]
test_plot$type <- "orig"
test_plot <- rbind(test_plot, data.frame(mz = test_mz$mz, intensity = out_cauchy, type = "cauchy"))

ggplot(test_plot, aes(x = mz, y = intensity, color = type)) + geom_line() + geom_point()

test_mz$max_value <- max(test_mz$intensity)
fit_weight <- test_mz$intensity / test_mz$max_value
fit <- nls(intensity ~ cauchy_estimate(mz, max_value, c(xnot, g)), data = test_mz, start = c(xnot = x.0, g = gamma.0), 
           nls.control(minFactor = 1/1e14, warnOnly = TRUE, maxiter = 200), weights = fit_weight)

fit_cauchy <- fit$m$predict()

fit_cauchy <- data.frame(mz = test_mz$mz, intensity = fit_cauchy, type = "fit")
ggplot(test_plot, aes(x = mz, y = intensity, color = type)) + geom_point() + geom_line() +
  geom_point(data = fit_cauchy) + geom_line(data = fit_cauchy)
```


# Workflow for Transient-Level Peak Finding

* Transform to log-space
* Find peaks using `pracma::findpeaks`
* For each peak:
    * Check that non-zero points have significant area
    * Fit a parabolic model to non-zero points
    * Find the peak center and intensity based on the model
    * Integrate parabola and sides to get peak area

```{r peak_pick_one_transient}
scan_peaks <- find_peaks(scan_level)
```

# Check Parabolic vs Basic differences

We will look for examples where there is a big difference in the `model` center
and the `basic` center, as that may imply there is something odd going on.

```{r model_vs_basic}
basic_peaks <- dplyr::filter(scan_peaks, type == "basic")
area_peaks <- dplyr::filter(scan_peaks, type == "area")
rsq_98_peaks <- dplyr::filter(scan_peaks, type == "rsq_98")
rsq_95_peaks <- dplyr::filter(scan_peaks, type == "rsq_95")

area_diff <- abs(area_peaks$ObservedMZ - basic_peaks$ObservedMZ)
rsq_98_diff <- abs(rsq_98_peaks$ObservedMZ - basic_peaks$ObservedMZ)
rsq_95_diff <- abs(rsq_95_peaks$ObservedMZ - basic_peaks$ObservedMZ)

sum(area_diff <= 5e-4)

sum(is.na(rsq_98_diff))
sum(rsq_98_diff[!is.na(rsq_98_diff)] <= 5e-4)

sum(is.na(rsq_95_diff))
sum(rsq_95_diff[!is.na(rsq_95_diff)] <= 5e-4)

```

```{r plot_all_peaks}
library(plotly)
p <- ggplot(scan_level, aes(x = mz, y = intensity)) + geom_line()
q <- p + geom_point(data = scan_peaks, aes(x = ObservedMZ, y = Intensity, color = type))
ggplotly(q)
```

```{r check_2556}
use_peak <- 2556

mz_data <- dplyr::filter(scan_level, (mz >= 1174.77) & (mz <= 1174.8))
min_points <- 5
n_peak <- Inf

peak_locations <- pracma::findpeaks(mz_data$intensity, nups = floor(min_points/2),
                                      ndowns = floor(min_points/2))
peak_locations <- matrix(peak_locations, ncol = 4, byrow = FALSE)
mz_data$log_int <- metabolomicsUtilities::log_with_min(mz_data$intensity)

in_peak <- 1
peak_loc <- seq(peak_locations[in_peak, 3], peak_locations[in_peak, 4])

possible_peak <- mz_data[peak_loc, ]



mz_data_plot1 <- mz_data
mz_data_plot1$type <- "org"
mz_data_plot1 <- rbind(mz_data_plot1, mz_data_plot1[peak_loc, ])
mz_data_plot1[23:34, "type"] <- "pracma"

ggplot(mz_data_plot1, aes(x = mz, y = intensity, color = type)) + geom_point() + geom_line()
```

OK, this looks good. Lets see what went into the model.

```{r}
possible_peak <- mz_data[peak_loc, ]
min_area <- 0.1

area_peak <- SIRM.FTMS.peakPickingMethods:::test_peak_area(possible_peak[, c("mz", "intensity")], min_points = min_points - 2)
area_points <- SIRM.FTMS.peakPickingMethods:::choose_peak_points_area(area_peak, min_area)


```

# Things to Do

* For area based peak method, can we exclude points based on their slope to
the next point in the peak? Points to exclude would have low slopes at
the ends.
* Alternatively, instead of R^2 on the parabolic model, could we use residuals
of the points to the model to exclude them?
* The way we should be judging the quality of each method is by examining
the variance in the location, intensity, and area of a given peak across
multiple transients.
